<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Калькулятор буста PFB</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --violet-1:#0b0014;
      --violet-2:#140029;
      --violet-3:#2a0052;
      --violet-4:#5a1aff;
      --violet-5:#a66bff;
      --accent:#c04dff;
      --accent-2:#6f7dff;
      --ok:#47d16a;
      --danger:#ff5470;
      --text:#e9e6f0;
      --muted:#bdb7c9;
      --glass-bg: rgba(255,255,255,0.08);
      --glass-stroke: rgba(255,255,255,0.22);
      --glass-blur: 16px;
      --radius: 18px;
      --shadow: 0 20px 60px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);
      --glow: 0 0 18px rgba(192,77,255,0.35), 0 0 42px rgba(111,125,255,0.25);
      --speed: .25s;
      --speed-slow: .45s;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Arial,Helvetica,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% -5%, rgba(111,125,255,0.18), transparent 60%),
        radial-gradient(1000px 900px at 85% 10%, rgba(192,77,255,0.22), transparent 60%),
        linear-gradient(180deg, var(--violet-2), var(--violet-1) 40%, var(--violet-3));
      overflow-x:hidden;
    }

    /* Floating orbs for depth */
    .orb{
      position:fixed;
      border-radius:50%;
      filter:blur(48px);
      opacity:0.45;
      pointer-events:none;
      mix-blend-mode:screen;
      animation:float var(--speed-slow) ease-in-out infinite alternate;
    }
    .orb.one{width:300px;height:300px;left:-80px;top:-40px;background:radial-gradient(circle at 30% 30%, #8f71ff, transparent);}
    .orb.two{width:260px;height:260px;right:120px;top:120px;background:radial-gradient(circle at 50% 50%, #c04dff, transparent);animation-duration:6s}
    .orb.three{width:220px;height:220px;left:50%;bottom:-60px;transform:translateX(-50%);background:radial-gradient(circle at 50% 50%, #6f7dff, transparent);animation-duration:7.5s}
    @keyframes float{
      from{transform:translateY(0)}
      to{transform:translateY(-10px)}
    }

    header{
      padding:48px 24px 8px;
      text-align:center;
    }
    h1{
      margin:0;
      font-weight:800;
      letter-spacing:.3px;
      font-size:34px;
      text-shadow:var(--glow);
    }
    .subtitle{
      margin-top:10px;
      color:var(--muted);
      font-size:15px;
    }

    .container{
      max-width:1180px;
      margin:28px auto 80px;
      padding:0 16px;
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:18px;
    }
    @media (max-width: 980px){
      .container{grid-template-columns: 1fr}
    }

    .card{
      background:var(--glass-bg);
      border:1px solid var(--glass-stroke);
      border-radius:var(--radius);
      backdrop-filter: blur(var(--glass-blur));
      box-shadow:var(--shadow);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    .card::after{
      content:"";
      position:absolute;inset:-1px;
      border-radius:inherit;
      pointer-events:none;
      background:linear-gradient(180deg, rgba(255,255,255,0.10), transparent 40%);
      mask:linear-gradient(180deg, #000, transparent 50%);
    }
    .card h2{
      margin:2px 0 14px;
      font-size:20px;
      font-weight:800;
      letter-spacing:.2px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(2,1fr);
      gap:12px;
    }
    @media (max-width:640px){ .grid{grid-template-columns: 1fr} }

    label{
      display:block;
      font-size:13px;
      color:var(--muted);
      margin-bottom:8px;
    }
    .field{
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.18);
      border-radius:14px;
      padding:12px 14px;
      color:var(--text);
      outline:none;
      width:100%;
      transition:border-color var(--speed), transform var(--speed);
    }
    .field:focus{
      border-color:var(--accent);
      transform:translateY(-1px);
      box-shadow:0 0 0 4px rgba(192,77,255,0.18);
    }
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

    /* Toggle fancy */
    .toggle{
      display:flex;align-items:center;gap:10px
    }
    .toggle .label{
      font-size:14px;color:var(--muted)
    }
    .switch{
      position:relative;width:98px;height:36px;
      background:linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.04));
      border:1px solid rgba(255,255,255,0.18);
      border-radius:24px;cursor:pointer;
      display:flex;align-items:center;justify-content:space-between;
      padding:0 8px;
      backdrop-filter:blur(10px);
      user-select:none;
      transition:box-shadow var(--speed);
    }
    .switch:hover{box-shadow:var(--glow)}
    .switch span{
      font-size:12px;color:var(--muted);z-index:2;
      width:50%;text-align:center
    }
    .knob{
      position:absolute;top:3px;bottom:3px;
      width:48px;border-radius:20px;
      background:radial-gradient(circle at 30% 20%, rgba(255,255,255,0.8), rgba(255,255,255,0.1));
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.35), 0 6px 16px rgba(0,0,0,0.35), 0 0 10px rgba(192,77,255,0.45);
      transform:translateX(-5px);
      transition:transform var(--speed-slow) cubic-bezier(.2,.8,.2,1);
    }
    .switch.on .knob{ transform:translateX(37px) }
    .switch .active{ color:#fff; text-shadow:0 0 8px rgba(255,255,255,0.55) }

    /* Slider DD */
    .dd-wrap{
      display:flex;align-items:center;gap:14px
    }
    .dd-slider{ -webkit-appearance:none; width:160px; height:8px; border-radius:10px;
      background:linear-gradient(90deg, rgba(255,255,255,0.25), rgba(192,77,255,0.65));
      outline:none; transition:filter var(--speed)
    }
    .dd-slider:hover{ filter:brightness(1.1) }
    .dd-slider::-webkit-slider-thumb{
      -webkit-appearance:none; width:24px;height:24px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%, #fff, #c9b9ff);
      border:1px solid rgba(255,255,255,0.7);
      box-shadow:0 4px 12px rgba(0,0,0,0.35), 0 0 16px rgba(192,77,255,0.55);
      cursor:pointer;
    }
    .badge{
      padding:6px 10px; border-radius:999px; font-size:12px;
      background:rgba(192,77,255,0.16); border:1px solid rgba(192,77,255,0.4);
      color:#fff; box-shadow:var(--glow)
    }
    /* Select styling */
    select.field{
      -webkit-appearance:none; appearance:none;
      padding-right:42px; cursor:pointer;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="%23c04dff"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat:no-repeat; background-position: calc(100% - 14px) 50%; background-size:16px;
    }
    select.field:hover{ filter:brightness(1.05) }
    select.field:focus{ box-shadow:0 0 0 4px rgba(192,77,255,0.18) }
    select.field::-ms-expand{ display:none }
    select option { background-color:#2b2b2b; color:#fff }

    /* Fancy custom select dropdown */
    .fs-wrapper{ position:relative; width:100% }
    .fs-display{
      display:block; width:100%; cursor:pointer; user-select:none;
      background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.18);
      border-radius:14px; padding:12px 42px 12px 14px; color:var(--text);
      position:relative; transition:border-color var(--speed), transform var(--speed);
    }
    .fs-display:after{
      content:""; position:absolute; right:14px; top:50%; width:16px; height:16px; transform:translateY(-50%);
      background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="%23c04dff"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat center/16px;
      opacity:.9
    }
    .fs-display:focus{ outline:none; border-color:var(--accent); transform:translateY(-1px); box-shadow:0 0 0 4px rgba(192,77,255,0.18) }
    .fs-menu{
      position:absolute; left:0; right:0; top:calc(100% + 6px); z-index:1000; max-height:260px; overflow:auto;
      border-radius:14px; border:1px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(14px) saturate(120%);
      background:linear-gradient(180deg, rgba(20,0,41,0.94), rgba(20,0,41,0.88));
      box-shadow:0 14px 36px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.06);
      display:none
    }
    .fs-menu.open{ display:block; animation:fade .18s ease }
    .fs-option{
      padding:12px 14px; color:#fff; font-weight:700; letter-spacing:.2px; font-size:14px;
      display:flex; align-items:center; justify-content:space-between; cursor:pointer;
      text-shadow:0 1px 2px rgba(0,0,0,0.35)
    }
    .fs-option:not(:last-child){ border-bottom:1px solid rgba(255,255,255,0.08) }
    .fs-option:hover{ background:rgba(192,77,255,0.18) }
    .fs-option.active{ background:rgba(192,77,255,0.28) }

    /* Buttons */
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      border:none;cursor:pointer;
      padding:12px 16px; border-radius:14px; font-weight:700; letter-spacing:.2px;
      color:#101018;
      background:linear-gradient(180deg, #fff, #d9c7ff);
      box-shadow: 0 10px 24px rgba(192,77,255,0.25), inset 0 1px 0 rgba(255,255,255,0.6);
      transition: transform var(--speed), box-shadow var(--speed);
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:0 16px 36px rgba(192,77,255,0.35), inset 0 1px 0 rgba(255,255,255,0.7) }
    .btn:active{ transform:translateY(0) scale(.99) }

    .btn-ghost{
      background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.25)
    }
    .btn-ghost:hover{ box-shadow:var(--glow) }

    .result{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;margin-top:10px;
      border-radius:14px;border:1px dashed rgba(255,255,255,0.25);
      background:rgba(255,255,255,0.04)
    }
    .result .sum{ font-size:24px; font-weight:800; letter-spacing:.4px }
    .hint{ font-size:12px; color:var(--muted) }

    /* Tabs for extra services */
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px }
    .tab{
      padding:8px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.2);
      background:rgba(255,255,255,0.05);
      color:#fff; cursor:pointer; font-size:13px; transition:all var(--speed)
    }
    .tab.active{ border-color:rgba(192,77,255,0.6); background:rgba(192,77,255,0.15); box-shadow:var(--glow) }
    .tab-content{ display:none; }
    .tab-content.active{ display:block; animation:fade .35s ease }
    @keyframes fade{ from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:translateY(0)} }

    .note{
      font-size:12px; color:var(--muted); margin-top:8px
    }

    /* Price editor panel */
    .editor{
      display:grid; gap:10px; grid-template-columns:1fr;
      max-height:480px; overflow:auto; padding-right:4px
    }
    .edit-row{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px;
    }
    .tiny{ font-size:12px; color:var(--muted) }
    .ok{ color:var(--ok) } .warn{ color:var(--danger) }

    /* Fancy scrollbars */
    *{ scrollbar-width:thin; scrollbar-color: var(--accent) transparent }
    *::-webkit-scrollbar{ width:10px; height:10px }
    *::-webkit-scrollbar-track{ background:var(--glass-bg); border-radius:10px }
    *::-webkit-scrollbar-thumb{
      background:linear-gradient(180deg, var(--accent), var(--accent-2));
      border-radius:10px; border:2px solid rgba(0,0,0,0.25);
      box-shadow:0 2px 10px rgba(192,77,255,0.4)
    }
    *::-webkit-scrollbar-thumb:hover{
      background:linear-gradient(180deg, #d17bff, #93a0ff)
    }

    /* Corner case for overlaying gif badge */
    .brand-gif{
      position:fixed; right:18px; bottom:18px; width:96px; height:96px;
      border-radius:14px; border:1px solid var(--glass-stroke);
      box-shadow:var(--shadow); opacity:.9; mix-blend-mode:screen;
      backdrop-filter: blur(6px);
      animation:float2 6s ease-in-out infinite alternate
    }
    @keyframes float2{ from{ transform:translateY(0) } to{ transform:translateY(-6px) } }
    @media (max-width:640px){ .brand-gif{ width:72px; height:72px; right:12px; bottom:12px } }
  </style>
</head>
<body>
  <div class="orb one"></div>
  <div class="orb two"></div>
  <div class="orb three"></div>
  <img class="brand-gif" src="brand.gif" alt="PFB"/>

  <header>
    <h1>Калькулятор буста PFB</h1>
    <div class="subtitle">discord: @emotionless_w</div>
  </header>

  <main class="container">
    <!-- Main calculator -->
    <section class="card">
      <h2>Калькулятор буста MMR</h2>

      <!-- Клиенты: переключение и добавление -->
      <div class="tabs" id="clientsTabs" style="margin-bottom:10px"></div>

      <div class="row" style="margin-bottom:12px">
        <div class="toggle" id="boostTypeToggle">
          <span class="label">Тип буста</span>
          <div class="switch" role="switch" aria-checked="false" tabindex="0">
            <span class="opt solo active">Соло</span>
            <span class="opt party">Пати</span>
            <div class="knob"></div>
          </div>
        </div>

        <div class="toggle" id="calcModeToggle">
          <span class="label">Режим</span>
          <div class="switch" role="switch" aria-checked="false" tabindex="0">
            <span class="opt mmr active">MMR</span>
            <span class="opt wins">WIN</span>
            <div class="knob"></div>
          </div>
        </div>

        <div class="toggle" id="ddToggle" title="ДД: Соло ×0.75; Пати до 5630 ×1.5, выше ×1.3">
          <span class="label">ДД</span>
          <div class="switch" role="switch" aria-checked="false" tabindex="0">
            <span class="opt off active">-</span>
            <span class="opt on">+</span>
            <div class="knob"></div>
          </div>
        </div>

        <div class="toggle" id="smurfToggle" title="Смурф-пулл: +процент к цене">
          <span class="label">Смурф-пулл</span>
          <div class="switch" role="switch" aria-checked="false" tabindex="0">
            <span class="opt off active">-</span>
            <span class="opt on">+</span>
            <div class="knob"></div>
          </div>
        </div>

        <div class="toggle" id="oneTwoPosToggle" title="1–2 позиции: до 6000 +20%, от 6000 +50%">
          <span class="label">1–2 позиции</span>
          <div class="switch" role="switch" aria-checked="false" tabindex="0">
            <span class="opt off active">-</span>
            <span class="opt on">+</span>
            <div class="knob"></div>
          </div>
        </div>

        <div style="flex-basis:100%; min-width:220px">
          <label>Профит, ₽</label>
          <input class="field" type="number" id="markupPercent" placeholder="например, 500" min="0" max="10000000" />
        </div>
      </div>

      <div class="grid">
        <div>
          <label>Изначальный MMR</label>
          <input class="field" type="number" id="mmrFrom" placeholder="например, 3210" min="1" max="11000" />
        </div>
        <div>
          <label>Порядочность клиента</label>
          <input class="field" type="number" id="conductScoreInput" placeholder="например, 5000" min="0" max="11000" />
        </div>
        <div id="mmrToWrap" style="grid-column: 1 / -1">
          <label>Конечный MMR</label>
          <input class="field" type="number" id="mmrTo" placeholder="например, 4500" min="1" max="11000" />
        </div>
      </div>

      <div id="winsBlock" style="display:none; margin-top:10px">
        <label>Количество побед</label>
        <input class="field" type="number" id="winsCount" placeholder="например, 10" min="1" max="500" />
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn" id="calcBtn">Рассчитать цену</button>
        <button class="btn btn-ghost" id="resetBtn">Сброс</button>
        <span class="hint">Суммирование по тарифным диапазонам. ДД: Соло ×0.75; Пати до 5630 ×1.5, выше ×1.3.</span>
      </div>

      <div class="result" style="margin-top:14px">
        <div>
          <div class="tiny">Итоговая стоимость (активный клиент)</div>
          <div class="sum" id="totalPrice">— ₽</div>
        </div>
        <div>
          <div class="tiny">Детализация</div>
          <div class="hint" id="breakdown">Введите данные и нажмите “Рассчитать”.</div>
        </div>
      </div>

      <!-- Общие итоги и комиссии -->
      <div class="result" style="margin-top:10px">
        <div>
          <div class="tiny">Итого по всем клиентам</div>
          <div class="sum" id="grandTotal">— ₽</div>
        </div>
      </div>

      <!-- FunPay pricing suggestion -->
      <div class="result" style="margin-top:10px">
        <div>
          <div class="tiny">Цена для FunPay [+14%]</div>
          <div class="sum" id="fpPriceLine">—</div>
        </div>
      </div>
    </section>

    <!-- Side tools -->
    <aside class="card">
      <h2>Настройки и доп. услуги</h2>

      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="editor">Настройка цен</div>
        <div class="tab" data-tab="calibration">Калибровка</div>
        <div class="tab" data-tab="coaching">Коучинг</div>
        <div class="tab" data-tab="battle">Боевой кубок</div>
        <div class="tab" data-tab="conduct">Порядочность</div>
        <div class="tab" data-tab="hours">100 часов</div>
      </div>

      <!-- Editor -->
      <div class="tab-content active" id="editor">
        <div class="note">Меняй прайсы — калькулятор сразу возьмет новые значения.</div>
        <div class="editor" id="editorRows"></div>
      </div>


      <!-- Calibration -->
      <div class="tab-content" id="calibration">
        <div class="grid">
          <div>
            <label>Диапазон MMR аккаунта</label>
            <input class="field" type="number" id="calibMmr" placeholder="например, 3500" min="0" max="11000"/>
          </div>
          <div>
            <label>Побед в калибровке</label>
            <input class="field" type="number" id="calibWins" placeholder="например, 10" min="1" max="10"/>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn" id="calibCalc">Рассчитать</button>
        </div>
        <div class="result" style="margin-top:14px">
          <div>
            <div class="tiny">Стоимость калибровки</div>
            <div class="sum" id="calibTotal">— ₽</div>
          </div>
          <div class="hint" id="calibHint">Цена за вин в диапазоне × кол-во побед.</div>
        </div>
      </div>

      <!-- Coaching -->
      <div class="tab-content" id="coaching">
        <div class="grid">
          <div>
            <label>Текущий MMR клиента</label>
            <input class="field" type="number" id="coachMmr" placeholder="например, 5200" min="0" max="11000"/>
          </div>
          <div>
            <label>Часы коучинга</label>
            <input class="field" type="number" id="coachHours" placeholder="например, 3" min="1" max="100"/>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn" id="coachCalc">Рассчитать</button>
        </div>
        <div class="result" style="margin-top:14px">
          <div>
            <div class="tiny">Стоимость коучинга</div>
            <div class="sum" id="coachTotal">— ₽</div>
          </div>
          <div class="hint" id="coachHint">Ставка по диапазону × часы.</div>
        </div>
      </div>

      <!-- Battle Cup -->
      <div class="tab-content" id="battle">
        <div class="grid">
          <div>
            <label>Тир боевого кубка</label>
            <div class="fs-wrapper" id="battleTierFS">
              <button type="button" class="fs-display" id="battleTierDisplay">3 тир</button>
              <div class="fs-menu" id="battleTierMenu">
                <div class="fs-option" data-value="3">3 тир</div>
                <div class="fs-option" data-value="4">4 тир</div>
                <div class="fs-option" data-value="5">5 тир</div>
                <div class="fs-option" data-value="6">6 тир</div>
                <div class="fs-option" data-value="7">7 тир</div>
                <div class="fs-option" data-value="8">8 тир</div>
              </div>
            </div>
          </div>
          <div style="display:flex;align-items:flex-end">
            <button class="btn" id="battleCalc" style="width:100%">Рассчитать</button>
          </div>
        </div>
        <div class="result" style="margin-top:14px">
          <div>
            <div class="tiny">Стоимость боевого кубка</div>
            <div class="sum" id="battleTotal">— ₽</div>
          </div>
          <div class="hint">Фиксированная цена по выбранному тиру.</div>
        </div>
      </div>

      <!-- Conduct / Low Priority -->
      <div class="tab-content" id="conduct">
        <div class="grid">
          <div>
            <label>Текущая порядочность</label>
            <input class="field" type="number" id="condFrom" placeholder="например, 4000" min="0" max="11000"/>
          </div>
          <div>
            <label>Желаемая порядочность</label>
            <input class="field" type="number" id="condTo" placeholder="например, 9000" min="0" max="11000"/>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <label style="margin:0">
            <input type="checkbox" id="condAccHigh" />
            Аккаунт для отмыва 7500+ MMR (+30%)
          </label>
          <button class="btn" id="condCalc">Рассчитать</button>
        </div>
        <div class="result" style="margin-top:14px">
          <div>
            <div class="tiny">Стоимость повышения порядочности</div>
            <div class="sum" id="condTotal">— ₽</div>
          </div>
          <div class="hint" id="condHint">Цена за каждые 1000 пунктов по диапазону. Применяется помесячно по сегментам.</div>
        </div>
      </div>

      <!-- 100 hours -->
      <div class="tab-content" id="hours">
        <div class="row">
          <div class="toggle" id="hoursToggle">
            <span class="label">Опт/Розница</span>
            <div class="switch" role="switch" aria-checked="false" tabindex="0">
              <span class="opt retail active">Розница</span>
              <span class="opt bulk">Опт</span>
              <div class="knob"></div>
            </div>
          </div>
        </div>
        <div class="grid" style="margin-top:10px">
          <div>
            <label>Часы</label>
            <input class="field" type="number" id="hoursCount" placeholder="например, 100" min="1" max="500"/>
          </div>
          <div style="display:flex;align-items:flex-end">
            <button class="btn" id="hoursCalc" style="width:100%">Рассчитать</button>
          </div>
        </div>
        <div class="result" style="margin-top:14px">
          <div>
            <div class="tiny">Стоимость часов</div>
            <div class="sum" id="hoursTotal">— ₽</div>
          </div>
          <div class="hint" id="hoursHint">Опт: 5000 ₽ за 100ч. Розница: 60 ₽/ч.</div>
        </div>
      </div>
    </aside>
  </main>

  <script>
    // ==========================
    // Конфиг цен (редактируй тут)
    // ==========================
    const pricesConfig = {
      mmrSoloRubPer100: [
        {from:   1, to: 2000,   rate:125},
        {from:2000, to: 3000,   rate:150},
        {from:3000, to: 3500,   rate:185},
        {from:3500, to: 4000,   rate:250},
        {from:4000, to: 4500,   rate:300},
        {from:4500, to: 5000,   rate:330},
        {from:5000, to: 5500,   rate:400},
        {from:5500, to: 6500,   rate:500},
        {from:6500, to: 7500,   rate:600},
        {from:7500, to: 8500,   rate:650},
        {from:8500, to: 9000,   rate:900},
        {from:9000, to: 9500,   rate:1200},
        {from:9500, to:10000,   rate:1400},
        {from:10000,to:10500,   rate:1700},
        {from:10500,to:11000,   rate:2000},
      ],
      // ДД настройки
      ddSplitThreshold: 5630,     // порог разделения ДД
      ddPercentBelow: 30,         // % до/включая порог
      ddPercentAbove: 50,         // % выше порога
      ddMode: 'percent',          // совместимость; при split-настройках игнорируется
      ddValue: 30,                // совместимость; при split-настройках игнорируется

      // Пати буст (за вин)
      partyPerWin: [
        {from:  10, to: 2000, rate: 55},
        {from:2000, to: 3000, rate: 65},
        {from:3000, to: 3500, rate: 75},
        {from:3500, to: 4000, rate: 90},
        {from:4000, to: 4500, rate:100},
        {from:4500, to: 5000, rate:135},
        {from:5000, to: 5500, rate:165},
        {from:5500, to: 6000, rate:200},
        {from:6000, to: 6500, rate:300},
        {from:6500, to: 7000, rate:400},
        {from:7000, to: 7500, rate:500},
        {from:7500, to: 8000, rate:700},
        {from:8000, to: 8500, rate:850},
        {from:8500, to: 9000, rate:1000},
        {from:9000, to: 9500, rate:1200},
        {from:9500, to:10000, rate:1500},
        {from:10000,to:10500, rate:1800},
        {from:10500,to:11000, rate:2000},
      ],

      // Калибровка (за вин, с передачей)
      calibrationPerWin: [
        {from:   0, to: 2000,  rate: 55},
        {from:2000, to: 3000,  rate: 65},
        {from:3000, to: 4000,  rate: 75},
        {from:4000, to: 4500,  rate: 90},
        {from:4500, to: 5000,  rate:100},
        {from:5000, to: 5500,  rate:135},
        {from:5500, to: 6000,  rate:165},
        {from:6000, to: 6500,  rate:200},
        {from:6500, to: 7000,  rate:250},
        {from:7000, to: 7500,  rate:300},
        {from:7500, to: 8000,  rate:350},
        {from:8000, to: 8500,  rate:400},
        {from:8500, to: 9000,  rate:500},
        {from:9000, to: 9500,  rate:650},
        {from:9500, to:10000,  rate:750},
        {from:10000,to:10500,  rate:850},
        {from:10500,to:11000,  rate:1000},
      ],

      // Коучинг (руб/час)
      coachingHourly: [
        {from:   0, to: 5630,  rate: 330},
        {from:5630, to: 7000,  rate: 500},
        {from:7000, to:20000,  rate: 700},
      ],

      // Боевой кубок
      battleCup: {
        3:200, 4:250, 5:300, 6:400, 7:500, 8:1000
      },

      // Порядочность (за 1000)
      conductPer1000: [
        // читаем “на промежутке от 9000” как 9000–11000
        {from: 9000, to:11000, rate:4000},
        // до 9000 (5000–9000)
        {from: 5000, to: 9000, rate:3000},
        // до 5000 (0–5000)
        {from:    0, to: 5000, rate:2000},
      ],
      conductAccHighMultiplier: 1.30, // 7500+ ммр
      hours: { bulk100: 5000, retailPerHour: 60 },

      // Смурф-пулл надбавка (проценты)
      smurfPoolPercent: 15,

      // Комиссии FunPay
      fpFeesLotPercent: 11,
      fpWithdrawPercent: 3
    };

    // ==============
    // Утилиты
    // ==============
    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
    const fmt = n => n.toLocaleString('ru-RU');
    const ceil2 = (v)=> Math.ceil((v + Number.EPSILON) * 100) / 100;

    function getRateFromRanges(ranges, mmr){
      return ranges.find(r => mmr >= r.from && mmr < r.to)?.rate ?? ranges[ranges.length-1].rate;
    }

    function segmentSum(from, to, ranges, per=100){
      if(to<=from) return {sum:0, parts:[]};
      let sum=0, remainFrom=from, parts=[];
      for(const r of ranges){
        const lo=Math.max(remainFrom, r.from);
        const hi=Math.min(to, r.to);
        if(hi>lo){
          const delta=hi-lo;
          const part = (delta/per)*r.rate;
          sum += part;
          parts.push({range:`${r.from}-${r.to}`, delta, rate:r.rate, cost:part});
        }
        if(to<=r.to) break;
      }
      return {sum, parts};
    }

    // ==============
    // Main MMR calc
    // ==============
    const mmrFromEl = document.getElementById('mmrFrom');
    const mmrToEl   = document.getElementById('mmrTo');
    const calcBtn   = document.getElementById('calcBtn');
    const resetBtn  = document.getElementById('resetBtn');
    const totalEl   = document.getElementById('totalPrice');
    const breakdownEl = document.getElementById('breakdown');
    const ddToggle  = document.querySelector('#ddToggle .switch');
    const smurfToggle = document.querySelector('#smurfToggle .switch');
    const oneTwoPosToggle = document.querySelector('#oneTwoPosToggle .switch');
    const winsBlock = document.getElementById('winsBlock');
    const winsCountEl = document.getElementById('winsCount');
    const markupPercentEl = document.getElementById('markupPercent');
    const fpPriceLineEl = document.getElementById('fpPriceLine');
    const conductScoreInput = document.getElementById('conductScoreInput');
    const clientsTabsEl = document.getElementById('clientsTabs');
    const grandTotalEl = document.getElementById('grandTotal');

    // Toggle: Соло/Пати
    const boostTypeToggle = document.querySelector('#boostTypeToggle .switch');
    let isParty = false;
    const setBoostToggleUI = ()=>{
      boostTypeToggle.classList.toggle('on', isParty);
      boostTypeToggle.setAttribute('aria-checked', String(isParty));
      boostTypeToggle.querySelector('.solo').classList.toggle('active', !isParty);
      boostTypeToggle.querySelector('.party').classList.toggle('active', isParty);
    };
    boostTypeToggle.addEventListener('click', ()=>{ isParty=!isParty; setBoostToggleUI(); });
    boostTypeToggle.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); isParty=!isParty; setBoostToggleUI(); }});
    setBoostToggleUI();

    // DD toggle
    let isDD = false;
    const setDDUI = ()=>{
      ddToggle.classList.toggle('on', isDD);
      ddToggle.setAttribute('aria-checked', String(isDD));
      ddToggle.querySelector('.off').classList.toggle('active', !isDD);
      ddToggle.querySelector('.on').classList.toggle('active', isDD);
    };
    ddToggle.addEventListener('click', ()=>{ isDD=!isDD; setDDUI(); });
    ddToggle.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); isDD=!isDD; setDDUI(); }});
    setDDUI();

    // Смурф toggle (как DD)
    let isSmurf = false;
    const setSmurfUI = ()=>{
      smurfToggle.classList.toggle('on', isSmurf);
      smurfToggle.setAttribute('aria-checked', String(isSmurf));
      smurfToggle.querySelector('.off').classList.toggle('active', !isSmurf);
      smurfToggle.querySelector('.on').classList.toggle('active', isSmurf);
    };
    smurfToggle.addEventListener('click', ()=>{ isSmurf=!isSmurf; setSmurfUI(); });
    smurfToggle.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); isSmurf=!isSmurf; setSmurfUI(); }});
    setSmurfUI();

    // 1–2 позиции toggle
    let isOneTwoPos = false;
    const setOneTwoPosUI = ()=>{
      oneTwoPosToggle.classList.toggle('on', isOneTwoPos);
      oneTwoPosToggle.setAttribute('aria-checked', String(isOneTwoPos));
      oneTwoPosToggle.querySelector('.off').classList.toggle('active', !isOneTwoPos);
      oneTwoPosToggle.querySelector('.on').classList.toggle('active', isOneTwoPos);
    };
    oneTwoPosToggle.addEventListener('click', ()=>{ isOneTwoPos=!isOneTwoPos; setOneTwoPosUI(); calcMain(true); });
    oneTwoPosToggle.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); isOneTwoPos=!isOneTwoPos; setOneTwoPosUI(); calcMain(true); }});
    setOneTwoPosUI();

    // Recalc on toggles
    ddToggle.addEventListener('click', ()=>calcMain(true));
    ddToggle.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ calcMain(true); }});
    smurfToggle.addEventListener('click', ()=>calcMain(true));
    smurfToggle.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ calcMain(true); }});
    conductScoreInput.addEventListener('input', ()=>calcMain(true));

    // Toggle: Режим расчёта (MMR / Победы)
    const calcModeToggle = document.querySelector('#calcModeToggle .switch');
    let isWinsMode = false;
    const setModeUI = ()=>{
      calcModeToggle.classList.toggle('on', isWinsMode);
      calcModeToggle.setAttribute('aria-checked', String(isWinsMode));
      calcModeToggle.querySelector('.mmr').classList.toggle('active', !isWinsMode);
      calcModeToggle.querySelector('.wins').classList.toggle('active', isWinsMode);
      winsBlock.style.display = isWinsMode ? 'block' : 'none';
      const mmrToWrap = document.getElementById('mmrToWrap');
      if(mmrToWrap){ mmrToWrap.style.display = isWinsMode ? 'none' : ''; }
    };
    calcModeToggle.addEventListener('click', ()=>{ isWinsMode=!isWinsMode; setModeUI(); });
    calcModeToggle.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); isWinsMode=!isWinsMode; setModeUI(); }});
    setModeUI();

    // ==========================
    // Multi-client state
    // ==========================
    function makeClient(name){
      return {
        name,
        mmrFrom: 0,
        mmrTo: 0,
        winsCount: 0,
        isParty: false,
        isDD: false,
        isWinsMode: false,
        smurf: false,
        oneTwoPos: false,
        conductScore: 0,
        markupPercent: 0
      };
    }

    let clients = [ makeClient('Клиент 1') ];
    let activeClientIndex = 0;

    function renderClientsTabs(){
      clientsTabsEl.innerHTML = '';
      clients.forEach((c, idx)=>{
        const tab = document.createElement('div');
        tab.className = 'tab' + (idx===activeClientIndex?' active':'');
        const title = document.createElement('span');
        title.textContent = c.name;
        title.style.marginRight = '6px';
        tab.appendChild(title);

        const canDelete = clients.length > 1;
        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-ghost';
        delBtn.textContent = '×';
        delBtn.title = canDelete ? 'Удалить клиента' : 'Нельзя удалить последнего клиента';
        delBtn.style.padding = '4px 8px';
        delBtn.style.lineHeight = '1';
        delBtn.style.borderRadius = '10px';
        delBtn.disabled = !canDelete;
        delBtn.addEventListener('click', (e)=>{
          e.stopPropagation();
          if(!canDelete) return;
          // Сохраняем UI и удаляем клиента
          saveUIToClient();
          clients.splice(idx,1);
          if(activeClientIndex >= clients.length){ activeClientIndex = clients.length-1; }
          loadClientToUI();
          calcMain(true);
        });
        tab.appendChild(delBtn);

        tab.addEventListener('click', ()=>{
          saveUIToClient();
          activeClientIndex = idx;
          loadClientToUI();
          // Авто-пересчёт активного и агрегатов при переключении
          calcMain(true);
        });
        clientsTabsEl.appendChild(tab);
      });
      const addBtn = document.createElement('div');
      addBtn.className = 'tab';
      addBtn.textContent = '+ Добавить клиента';
      addBtn.addEventListener('click', ()=>{
        saveUIToClient();
        const newIdx = clients.length + 1;
        clients.push(makeClient(`Клиент ${newIdx}`));
        activeClientIndex = clients.length - 1;
        renderClientsTabs();
        loadClientToUI();
        calcMain(true);
      });
      clientsTabsEl.appendChild(addBtn);
    }

    function loadClientToUI(){
      const c = clients[activeClientIndex];
      mmrFromEl.value = c.mmrFrom || '';
      mmrToEl.value = c.mmrTo || '';
      winsCountEl.value = c.winsCount || '';
      isSmurf = !!c.smurf; setSmurfUI();
      isOneTwoPos = !!c.oneTwoPos; setOneTwoPosUI();
      conductScoreInput.value = c.conductScore || '';
      markupPercentEl.value = (c.markupPercent ?? 0) || '';

      isParty = !!c.isParty; setBoostToggleUI();
      isDD = !!c.isDD; setDDUI();
      isWinsMode = !!c.isWinsMode; setModeUI();
      renderClientsTabs();
    }

    function saveUIToClient(){
      const c = clients[activeClientIndex];
      c.mmrFrom = clamp(Number(mmrFromEl.value||0), 0, 11000);
      c.mmrTo = clamp(Number(mmrToEl.value||0), 0, 11000);
      c.winsCount = clamp(Number(winsCountEl.value||0), 0, 10000);
      c.smurf = !!isSmurf;
      c.oneTwoPos = !!isOneTwoPos;
      c.conductScore = clamp(Number(conductScoreInput.value||0), 0, 11000);
      c.markupPercent = clamp(Number(markupPercentEl.value||0), 0, 100000000);
      c.isParty = !!isParty;
      c.isDD = !!isDD;
      c.isWinsMode = !!isWinsMode;
    }

    function computeClient(c){
      const from = clamp(Number(c.mmrFrom||0), 1, 11000);
      let to = clamp(Number(c.mmrTo||0), 1, 11000);
      let winsInput = 0;
      let parts = [];
      let descriptionLines = [];

      if(c.isWinsMode){
        winsInput = clamp(Number(c.winsCount||0), 1, 10000);
        const mmrPerWin = c.isDD ? 50 : 25; // 50 MMR/вин при ДД, иначе 25
        const projectedTo = from + winsInput * mmrPerWin;
        to = clamp(projectedTo, 1, 11000);
      }

      if(!from || (!c.isWinsMode && (!to || to<=from))){
        return { ok:false, total:0, subtotal:0, ddExtra:0, smurfExtra:0, markupExtra:0, parts:[], lines:[] };
      }

      if(c.isParty){
        const mmrPerWin = c.isDD ? 50 : 25; // 50 MMR/вин при ДД, иначе 25
        let base = 0;
        let seg;
        if(c.isWinsMode){
          // Симуляция по играм как у конкурента: после каждого буста добавляем MMR,
          // берём ставку по текущему MMR и суммируем.
          let currentMMR = from;
          base = 0;
          for(let i=0;i<winsInput;i++){
            currentMMR += mmrPerWin;
            const rate = getRateFromRanges(pricesConfig.partyPerWin, currentMMR);
            base += rate;
          }
          descriptionLines.push(`Пати: ${winsInput} вин (шаг ${mmrPerWin} MMR), ставка по текущему MMR.`);
          seg = { parts: [] };
        } else {
          seg = segmentSum(from, to, pricesConfig.partyPerWin, mmrPerWin);
          base = seg.sum;
          descriptionLines.push(`Пати: от ${from} до ${to} MMR по диапазонам (≈ ${mmrPerWin} MMR/вин).`);
        }
        // Детализация по диапазонам
        seg.parts.forEach(p=>{
          const winsInRange = p.delta / mmrPerWin;
          const winsText = Number.isInteger(winsInRange) ? `${winsInRange}` : `≈${winsInRange.toFixed(2)}`;
          descriptionLines.push(`${winsText} вин в диапазоне ${p.range} × ${fmt(p.rate)} ₽/вин = ${fmt(p.cost)} ₽`);
        });
        // ДД множитель для Пати
        const ddMul = c.isDD ? ((from <= pricesConfig.ddSplitThreshold) ? 1.5 : 1.3) : 1.0;
        let running = base * ddMul;
        if(c.isDD) descriptionLines.push(`ДД множитель (Пати): ×${ddMul.toFixed(2)}`);

        // Смурф-пулл только от 3500 MMR
        const smurfAllowed = c.smurf && from >= 3500;
        const smurfExtra = smurfAllowed ? running * (pricesConfig.smurfPoolPercent/100) : 0;
        running += smurfExtra;

        // 1–2 позиции: до 6000 +20%, от 6000 +50%
        if(c.oneTwoPos){
          const posMul = from < 6000 ? 1.20 : 1.50;
          running *= posMul;
          descriptionLines.push(`1–2 позиции: ×${posMul.toFixed(2)}`);
        }

        const subtotal = running;
        const markupExtra = Number(c.markupPercent||0);
        const total = subtotal + markupExtra;
        if(smurfExtra>0) descriptionLines.push(`Смурф-пулл (от 3500): +${pricesConfig.smurfPoolPercent}% = +${fmt(smurfExtra)} ₽`);
        if(markupExtra>0) descriptionLines.push(`Профит: +${fmt(markupExtra)} ₽`);
        return { ok:true, total, subtotal:subtotal, ddExtra:(base*ddMul - base), smurfExtra:smurfExtra, markupExtra:markupExtra, parts:seg.parts, lines:descriptionLines };
      }

      // Соло
      const res = segmentSum(from, to, pricesConfig.mmrSoloRubPer100, 100);
      let baseSum = res.sum; parts = res.parts;
      // DD множитель для Соло
      let ddExtraCalc = 0;
      let baseAfterDDSolo = baseSum;
      if(c.isDD){
        const ddMulSolo = 0.75;
        baseAfterDDSolo = baseSum * ddMulSolo;
        ddExtraCalc = baseAfterDDSolo - baseSum; // отрицательная «надбавка» (скидка)
      }

      // Смурф-пулл только от 3500
      const smurfExtraCalc = (c.smurf && from >= 3500) ? (baseAfterDDSolo) * (pricesConfig.smurfPoolPercent/100) : 0;
      let runningSolo = baseAfterDDSolo + smurfExtraCalc;

      // 1–2 позиции для соло
      if(c.oneTwoPos){
        const posMulSolo = from < 6000 ? 1.20 : 1.50;
        runningSolo *= posMulSolo;
        descriptionLines.push(`1–2 позиции: ×${posMulSolo.toFixed(2)}`);
      }

      const subtotalCalc = runningSolo;
      const markupExtraCalc = Number(c.markupPercent||0);
      const totalCalc = subtotalCalc + markupExtraCalc;

      if(c.isWinsMode){
        const mmrPerWin = c.isDD ? 50 : 25;
        const gained = to - from;
        descriptionLines.push(`По победам: ${winsInput} × ${mmrPerWin} MMR = ${fmt(gained)} MMR`);
      }
      parts.forEach(p=>{
        descriptionLines.push(`${p.delta} MMR в диапазоне ${p.range} × ${fmt(p.rate)} ₽/100 = ${fmt(p.cost)} ₽`);
      });
      if(c.isDD){ descriptionLines.push(`ДД множитель (Соло): ×0.75`); }
      if(smurfExtraCalc>0){ descriptionLines.push(`Смурф-пулл (от 3500): +${pricesConfig.smurfPoolPercent}% = +${fmt(smurfExtraCalc)} ₽`); }
      if(markupExtraCalc>0){ descriptionLines.push(`Профит: +${fmt(markupExtraCalc)} ₽`); }
      return { ok:true, total: totalCalc, subtotal: subtotalCalc, ddExtra: ddExtraCalc, smurfExtra: smurfExtraCalc, markupExtra: markupExtraCalc, parts, lines: descriptionLines };
    }

    function recalcGrand(){
      // Суммируем итог после наценки по всем клиентам
      let sumAll = 0;
      let activeTotal = 0;
      clients.forEach(c=>{
        const r = computeClient(c);
        if(r.ok){
          sumAll += r.total;
          if(c===clients[activeClientIndex]) activeTotal = r.total;
        }
      });
      if(sumAll<=0){
        grandTotalEl.textContent = '— ₽';
        fpPriceLineEl.textContent = '—';
        return;
      }
      const sumAllC = ceil2(sumAll);
      grandTotalEl.textContent = `${fmt(sumAllC)} ₽`;
      const lotFee = ceil2(sumAll * (pricesConfig.fpFeesLotPercent/100));
      const withdrawFee = ceil2(sumAll * (pricesConfig.fpWithdrawPercent/100));

      // FunPay 14%
      const fpMul = 1 + (pricesConfig.fpFeesLotPercent + pricesConfig.fpWithdrawPercent)/100; // 1.14
      const fpActive = ceil2(activeTotal * fpMul);
      const fpAll = ceil2(sumAll * fpMul);
      fpPriceLineEl.textContent = `Активный: ${fmt(fpActive)} ₽ | Все клиенты: ${fmt(fpAll)} ₽`;
    }

    function calcMain(isSilent){
      saveUIToClient();
      const r = computeClient(clients[activeClientIndex]);

      if(!r.ok){
        totalEl.textContent='— ₽';
        breakdownEl.textContent='Заполните корректные значения и попробуйте снова.';
      } else {
        totalEl.textContent = `${fmt(ceil2(r.total))} ₽`;
        breakdownEl.textContent = r.lines.join(' • ');
      }
      recalcGrand();
      if(!isSilent){ renderClientsTabs(); }
    }

    calcBtn.addEventListener('click', ()=>calcMain(false));
    markupPercentEl.addEventListener('input', ()=>calcMain(true));
    smurfToggle.addEventListener('click', ()=>calcMain(true));
    smurfToggle.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ calcMain(true); }});
    resetBtn.addEventListener('click', ()=>{
      // Сброс только активного клиента
      mmrFromEl.value = '';
      mmrToEl.value = '';
      winsCountEl.value = '';
      markupPercentEl.value = '';
      isSmurf=false; setSmurfUI();
      isDD=false; setDDUI();
      if(isParty){ isParty=false; setBoostToggleUI(); }
      if(isWinsMode){ isWinsMode=false; setModeUI(); }
      totalEl.textContent='— ₽';
      breakdownEl.textContent='Введите данные и нажмите “Рассчитать”.';
      saveUIToClient();
      recalcGrand();
    });

    // Первичная инициализация
    renderClientsTabs();
    loadClientToUI();

    // ==========================
    // Tabs
    // ==========================
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    tabs.forEach(t=>{
      t.addEventListener('click', ()=>{
        tabs.forEach(x=>x.classList.remove('active'));
        tabContents.forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        document.getElementById(t.dataset.tab).classList.add('active');
      });
    });

    // ==========================
    // Editor UI
    // ==========================
    const editorRows = document.getElementById('editorRows');
    function renderEditor(){
      editorRows.innerHTML = '';

      // Блок: Соло (за 100 MMR)
      const soloTitle = document.createElement('div');
      soloTitle.innerHTML = '<div class="tiny">Соло буст (₽ за 100 MMR)</div>';
      editorRows.appendChild(soloTitle);

      pricesConfig.mmrSoloRubPer100.forEach((r, idx)=>{
        const row = document.createElement('div');
        row.className='edit-row';
        row.innerHTML = `
          <input class="field" type="text" value="${r.from}-${r.to}" disabled />
          <input class="field" type="number" value="${r.rate}" min="1" />
        `;
        const input = row.querySelector('input[type="number"]');
        input.addEventListener('input', ()=>{
          pricesConfig.mmrSoloRubPer100[idx].rate = Number(input.value||0);
        });
        editorRows.appendChild(row);
      });

      // DD

      const ddModeRow = document.createElement('div');
      ddModeRow.className='edit-row';
      ddModeRow.innerHTML = `
        <select class="field" id="ddModeSel">
          <option value="percent" ${pricesConfig.ddMode==='percent'?'selected':''}>ДД надбавка (%)</option>
          <option value="fixed" ${pricesConfig.ddMode==='fixed'?'selected':''}>ДД фикс (₽)</option>
        </select>
        <input class="field" type="number" step="0.01" id="ddValueInp" value="${pricesConfig.ddValue}" min="0" />
      `;
      ddModeRow.querySelector('#ddModeSel').addEventListener('change', (e)=>{
        pricesConfig.ddMode = e.target.value;
      });
      ddModeRow.querySelector('#ddValueInp').addEventListener('input', (e)=>{
        pricesConfig.ddValue = Number(e.target.value||0);
      });
      editorRows.appendChild(ddModeRow);

      // Пати
      const partyTitle = document.createElement('div');
      partyTitle.innerHTML = '<div class="tiny" style="margin-top:6px">Пати буст (₽ за вин)</div>';
      editorRows.appendChild(partyTitle);

      pricesConfig.partyPerWin.forEach((r, idx)=>{
        const row = document.createElement('div');
        row.className='edit-row';
        row.innerHTML = `
          <input class="field" type="text" value="${r.from}-${r.to}" disabled />
          <input class="field" type="number" value="${r.rate}" min="1" />
        `;
        row.querySelector('input[type="number"]').addEventListener('input', (e)=>{
          pricesConfig.partyPerWin[idx].rate = Number(e.target.value||0);
        });
        editorRows.appendChild(row);
      });

      // Калибровка
      const calibTitle = document.createElement('div');
      calibTitle.innerHTML = '<div class="tiny" style="margin-top:6px">Калибровка (₽ за вин)</div>';
      editorRows.appendChild(calibTitle);

      pricesConfig.calibrationPerWin.forEach((r, idx)=>{
        const row = document.createElement('div');
        row.className='edit-row';
        row.innerHTML = `
          <input class="field" type="text" value="${r.from}-${r.to}" disabled />
          <input class="field" type="number" value="${r.rate}" min="1" />
        `;
        row.querySelector('input[type="number"]').addEventListener('input', (e)=>{
          pricesConfig.calibrationPerWin[idx].rate = Number(e.target.value||0);
        });
        editorRows.appendChild(row);
      });

      // Коучинг
      const coachTitle = document.createElement('div');
      coachTitle.innerHTML = '<div class="tiny" style="margin-top:6px">Коучинг (₽/час)</div>';
      editorRows.appendChild(coachTitle);

      pricesConfig.coachingHourly.forEach((r, idx)=>{
        const row = document.createElement('div');
        row.className='edit-row';
        row.innerHTML = `
          <input class="field" type="text" value="${r.from}-${r.to}" disabled />
          <input class="field" type="number" value="${r.rate}" min="1" />
        `;
        row.querySelector('input[type="number"]').addEventListener('input', (e)=>{
          pricesConfig.coachingHourly[idx].rate = Number(e.target.value||0);
        });
        editorRows.appendChild(row);
      });

      // Боевой кубок
      const battleTitle = document.createElement('div');
      battleTitle.innerHTML = '<div class="tiny" style="margin-top:6px">Боевой кубок (фикс, ₽)</div>';
      editorRows.appendChild(battleTitle);

      [3,4,5,6,7,8].forEach(t=>{
        const row = document.createElement('div');
        row.className='edit-row';
        row.innerHTML = `
          <input class="field" type="text" value="Тир ${t}" disabled />
          <input class="field" type="number" value="${pricesConfig.battleCup[t]}" min="0" />
        `;
        row.querySelector('input[type="number"]').addEventListener('input', (e)=>{
          pricesConfig.battleCup[t] = Number(e.target.value||0);
        });
        editorRows.appendChild(row);
      });

      // Порядочность
      const condTitle = document.createElement('div');
      condTitle.innerHTML = '<div class="tiny" style="margin-top:6px">Порядочность (₽ за 1000)</div>';
      editorRows.appendChild(condTitle);

      pricesConfig.conductPer1000
        .sort((a,b)=>a.from-b.from)
        .forEach((r, idx)=>{
          const row = document.createElement('div');
          row.className='edit-row';
          row.innerHTML = `
            <input class="field" type="text" value="${r.from}-${r.to}" disabled />
            <input class="field" type="number" value="${r.rate}" min="0" />
          `;
          row.querySelector('input[type="number"]').addEventListener('input', (e)=>{
            pricesConfig.conductPer1000[idx].rate = Number(e.target.value||0);
          });
          editorRows.appendChild(row);
        });

      const condMulTitle = document.createElement('div');
      condMulTitle.className='edit-row';
      condMulTitle.innerHTML = `
        <input class="field" type="text" value="Акк 7500+ MMR множитель" disabled />
        <input class="field" type="number" step="0.01" value="${pricesConfig.conductAccHighMultiplier}" min="1" />
      `;
      condMulTitle.querySelector('input[type="number"]').addEventListener('input', (e)=>{
        pricesConfig.conductAccHighMultiplier = Number(e.target.value||0);
      });
      editorRows.appendChild(condMulTitle);

      // Смурф-пулл
      const smurfRow = document.createElement('div');
      smurfRow.className='edit-row';
      smurfRow.innerHTML = `
        <input class="field" type="text" value="Смурф-пулл надбавка (%)" disabled />
        <input class="field" type="number" step="0.1" value="${pricesConfig.smurfPoolPercent}" min="0" />
      `;
      smurfRow.querySelector('input[type="number"]').addEventListener('input', (e)=>{
        pricesConfig.smurfPoolPercent = Number(e.target.value||0);
      });
      editorRows.appendChild(smurfRow);

      // 100 часов
      const hoursTitle = document.createElement('div');
      hoursTitle.innerHTML = '<div class="tiny" style="margin-top:6px">Часы</div>';
      editorRows.appendChild(hoursTitle);

      const hoursBulkRow = document.createElement('div');
      hoursBulkRow.className='edit-row';
      hoursBulkRow.innerHTML = `
        <input class="field" type="text" value="Опт (100 ч)" disabled />
        <input class="field" type="number" value="${pricesConfig.hours.bulk100}" min="0" />
      `;
      hoursBulkRow.querySelector('input[type="number"]').addEventListener('input', (e)=>{
        pricesConfig.hours.bulk100 = Number(e.target.value||0);
      });
      editorRows.appendChild(hoursBulkRow);

      const hoursRetailRow = document.createElement('div');
      hoursRetailRow.className='edit-row';
      hoursRetailRow.innerHTML = `
        <input class="field" type="text" value="Розница (₽/час)" disabled />
        <input class="field" type="number" value="${pricesConfig.hours.retailPerHour}" min="0" />
      `;
      hoursRetailRow.querySelector('input[type="number"]').addEventListener('input', (e)=>{
        pricesConfig.hours.retailPerHour = Number(e.target.value||0);
      });
      editorRows.appendChild(hoursRetailRow);
    }
    renderEditor();

    // (Удалено) Party calc UI и обработчики

    // ==========================
    // Calibration calc
    // ==========================
    const calibMmr  = document.getElementById('calibMmr');
    const calibWins = document.getElementById('calibWins');
    const calibBtn  = document.getElementById('calibCalc');
    const calibTotal= document.getElementById('calibTotal');

    calibBtn.addEventListener('click', ()=>{
      const mmr = clamp(Number(calibMmr.value||0),0,11000);
      const wins = clamp(Number(calibWins.value||0),1,10);
      const rate = getRateFromRanges(pricesConfig.calibrationPerWin, mmr);
      const sum = rate * wins;
      calibTotal.textContent = `${fmt(sum)} ₽`;
    });

    // ==========================
    // Coaching calc
    // ==========================
    const coachMmr   = document.getElementById('coachMmr');
    const coachHours = document.getElementById('coachHours');
    const coachBtn   = document.getElementById('coachCalc');
    const coachTotal = document.getElementById('coachTotal');

    coachBtn.addEventListener('click', ()=>{
      const mmr = clamp(Number(coachMmr.value||0),0,20000);
      const hours = clamp(Number(coachHours.value||0),1,1000);
      const rate = getRateFromRanges(pricesConfig.coachingHourly, mmr);
      coachTotal.textContent = `${fmt(rate*hours)} ₽`;
    });

    // ==========================
    // Battle Cup calc
    // ==========================
    // Fancy select for Battle tier
    const battleTierDisplay = document.getElementById('battleTierDisplay');
    const battleTierMenu = document.getElementById('battleTierMenu');
    let battleTierValue = '3';
    battleTierDisplay.addEventListener('click', ()=>{
      battleTierMenu.classList.toggle('open');
    });
    battleTierMenu.querySelectorAll('.fs-option').forEach(opt=>{
      opt.addEventListener('click', ()=>{
        battleTierValue = opt.dataset.value;
        battleTierDisplay.textContent = opt.textContent;
        battleTierMenu.classList.remove('open');
        battleBtn.click();
      });
    });
    document.addEventListener('click', (e)=>{
      if(!document.getElementById('battleTierFS').contains(e.target)){
        battleTierMenu.classList.remove('open');
      }
    });
    const battleBtn  = document.getElementById('battleCalc');
    const battleTotal= document.getElementById('battleTotal');
    battleBtn.addEventListener('click', ()=>{
      const t = battleTierValue;
      battleTotal.textContent = `${fmt(pricesConfig.battleCup[t]||0)} ₽`;
    });

    // ==========================
    // Conduct calc
    // ==========================
    const condFrom   = document.getElementById('condFrom');
    const condTo     = document.getElementById('condTo');
    const condAccHigh= document.getElementById('condAccHigh');
    const condBtn    = document.getElementById('condCalc');
    const condTotal  = document.getElementById('condTotal');
    const condHint   = document.getElementById('condHint');

    function segmentSumConduct(from, to, ranges){
      if(to<=from) return {sum:0, parts:[]};
      let sum=0, parts=[];
      for(const r of ranges.sort((a,b)=>a.from-b.from)){
        const lo = Math.max(from, r.from);
        const hi = Math.min(to, r.to);
        if(hi>lo){
          const delta = hi - lo;
          const k = delta/1000;
          const cost = k * r.rate;
          sum+=cost;
          parts.push({range:`${r.from}-${r.to}`, delta, rate:r.rate, cost});
        }
        if(to<=r.to) break;
      }
      return {sum, parts};
    }

    condBtn.addEventListener('click', ()=>{
      const f = clamp(Number(condFrom.value||0),0,11000);
      const t = clamp(Number(condTo.value||0),0,11000);
      if(t<=f){ condTotal.textContent='— ₽'; condHint.textContent='Проверьте диапазон: цель должна быть выше текущей.'; return; }

      const {sum, parts} = segmentSumConduct(f, t, pricesConfig.conductPer1000);
      const mul = condAccHigh.checked ? pricesConfig.conductAccHighMultiplier : 1;
      const final = sum * mul;
      condTotal.textContent = `${fmt(final)} ₽`;
      const lines = parts.map(p=>`${p.delta} пунктов в ${p.range} × ${fmt(p.rate)} ₽/1000 = ${fmt(p.cost)} ₽`);
      if(mul>1) lines.push(`Множитель 7500+ MMR: ×${mul.toFixed(2)}`);
      condHint.textContent = lines.join(' • ');
    });

    // ==========================
    // Hours calc
    // ==========================
    const hoursToggle = document.querySelector('#hoursToggle .switch');
    let isBulk=false;
    const setHoursUI = ()=>{
      hoursToggle.classList.toggle('on', isBulk);
      hoursToggle.setAttribute('aria-checked', String(isBulk));
      hoursToggle.querySelector('.retail').classList.toggle('active', !isBulk);
      hoursToggle.querySelector('.bulk').classList.toggle('active', isBulk);
    };
    hoursToggle.addEventListener('click', ()=>{ isBulk=!isBulk; setHoursUI(); });
    hoursToggle.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); isBulk=!isBulk; setHoursUI(); }});
    setHoursUI();

    const hoursCount = document.getElementById('hoursCount');
    const hoursBtn   = document.getElementById('hoursCalc');
    const hoursTotal = document.getElementById('hoursTotal');
    const hoursHint  = document.getElementById('hoursHint');

    hoursBtn.addEventListener('click', ()=>{
      const h = clamp(Number(hoursCount.value||0),1,10000);
      let sum = 0;
      if(isBulk){
        // Оптовый пакет кратно 100 часам
        const packs = Math.floor(h / 100);
        const remainder = h % 100;
        sum = packs * pricesConfig.hours.bulk100 + remainder * pricesConfig.hours.retailPerHour;
        hoursHint.textContent = `${packs}×(100 ч по ${fmt(pricesConfig.hours.bulk100)} ₽) + ${remainder}×${fmt(pricesConfig.hours.retailPerHour)} ₽/ч.`;
      }else{
        sum = h * pricesConfig.hours.retailPerHour;
        hoursHint.textContent = `Розница: ${h}×${fmt(pricesConfig.hours.retailPerHour)} ₽/ч.`;
      }
      hoursTotal.textContent = `${fmt(sum)} ₽`;
    });
  </script>
</body>
</html>

